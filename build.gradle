apply plugin: 'java'

import org.gradle.internal.os.OperatingSystem;

task detect {
    doLast {
        println("Linux: " + OperatingSystem.current().isLinux())
        println("Windows: " + OperatingSystem.current().isWindows())
    }
}

task cleanup(type: Exec) {
    group "Jetty"
    description "Delete generated and runtime files"
    if (OperatingSystem.current().isWindows()) {
        workingDir './'
        commandLine 'powershell.exe', './scripts/clean.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
        workingDir './'
        commandLine './clean.sh'
    }
}

task generate(type: Exec) {
    group "Jetty"
    description "Create jazz and equinox configuration files"
    if (OperatingSystem.current().isWindows()) {
        workingDir 'conf/jetty'
        commandLine 'powershell.exe', '../../scripts/generate_jetty_config.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
        workingDir './conf/jetty'
        commandLine './generate_jetty_config.sh'
        ignoreExitValue true
    }
}

task run(type: Exec) {
    group "Jetty"
    description "Start jazz server"
    if (OperatingSystem.current().isWindows()) {
        workingDir './'
        commandLine 'cmd', '/K', 'start', 'powershell','./scripts/run_jetty.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
    }
}

// sadly, this is incredibly slow. Maybe the only option for this is actually calling
// an external task to unzip. Seriously uncool.
task unzip(type: Copy) {
    outputs.upToDateWhen {false}
    // how to unzip a file
    def zipFile = file('sdk/RTC-SDK-Server-6.0.3.zip')
    def outDir = file('unziptest/')

    from zipTree(zipFile)
    into outDir
}

task init {
    doLast {
        // how to get files in a dir
        def zips = []
        fileTree(dir: 'sdk', include: '*.zip').visit {
            FileVisitDetails details ->
                zips << details.file.name
        }

        println zips

        // how to work with custom properties from the command line
        if (project.hasProperty('sdk')) {
            println sdk
        }

        if (project.hasProperty('rtc')) {
            println rtc
        }
    }
}
