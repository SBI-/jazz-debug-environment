apply plugin: 'java'

import org.gradle.internal.os.OperatingSystem;

task detect {
    doLast {
        println("Linux: " + OperatingSystem.current().isLinux())
        println("Windows: " + OperatingSystem.current().isWindows())
    }
}

task cleanup(type: Exec) {
    group "Jetty"
    description "Delete generated and runtime files"
    if (OperatingSystem.current().isWindows()) {
        workingDir './'
        commandLine 'powershell.exe', './scripts/clean.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
        workingDir './'
        commandLine './scripts/clean.sh'
    }
}

task generate(type: Exec) {
    group "Jetty"
    description "Create jazz and equinox configuration files"
    if (OperatingSystem.current().isWindows()) {
        workingDir 'conf/jetty'
        commandLine 'powershell.exe', '../../scripts/generate_jetty_config.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
        workingDir './conf/jetty'
        commandLine '../../scripts/generate_jetty_config.sh'
        ignoreExitValue true
    }
}

// Behaviour for run will differ between windows and linux. For windows, launching a new shell is probably the way to
// go with how users would expect this script to be run.
// For linux however, I would like to avoid forking the process and instead run jetty in the same window, maybe defered
// after gradle has finished. However, forking doesn't really seem to work properly from within gradle, so I still
// have to figure out some other way to do this. Maybe just go back to running run_jetty from the command line or
// something like that.
task run(type: Exec) {
    group "Jetty"
    description "Start jazz server"
    if (OperatingSystem.current().isWindows()) {
        workingDir './'
        commandLine 'cmd', '/K', 'start', 'powershell','./scripts/run_jetty.ps1'
    }

    // this is the simple, non-unix and non-portable way of dealing with running jetty in a separate process
    // to keep consistent with the "new terminal window" solution:
    // https://askubuntu.com/questions/476641/how-can-i-get-the-name-of-the-current-terminal-from-command-line
    if (OperatingSystem.current().isLinux()) {
        workingDir './'
        commandLine 'gnome-terminal', '-x', './scripts/run_jetty.sh'
    }
}

task db {
    group "Jetty"
    description "Setup a clean database for the current sdk"

    doLast {
        File dbZip = getZip('./db_presets')

        if (OperatingSystem.current().isWindows()) {

        }

        if (OperatingSystem.current().isLinux()) {
            exec {
                workingDir './'
                commandLine 'unzip', '-q', dbZip, '-d', 'db'
                ignoreExitValue true
            }
        }
    }
}

task unzip {
    group "Jetty"
    description "Unzip sdk and server files into the correct folders"

    doLast {

        File sdkZip = getZip('./sdk')
        File jtsZip = getZip('./jre')

        if (OperatingSystem.current().isWindows()) {
            exec {
                workingDir './sdk'
                commandLine 'powershell', '7z.exe', 'x', sdkZip
            }

            exec {
                workingDir './jre'
                commandLine 'powershell', '7z.exe', 'x', jtsZip, 'server\\jre', '-r', ';',
                        'mv server\\jre\\* .', ';', 'rm -r server'
            }
        }

        // yeah, maybe I wanna put this in a separate file as well...
        if (OperatingSystem.current().isLinux()) {
            exec {
                workingDir './sdk'
                commandLine 'unzip', '-q', sdkZip
                ignoreExitValue true
            }

            exec {
                workingDir './jre'
                commandLine 'unzip', '-q', jtsZip, 'server/jre/*'
                ignoreExitValue true
            }

            exec {
                workingDir './jre'
                commandLine 'sh', '-c', 'cp -r server/jre/* .'
                ignoreExitValue true
            }

            exec {
                workingDir './jre'
                commandLine 'rm', '-r', 'server'
                ignoreExitValue true
            }
        }
    }
}

task kill {
    group "Jetty"
    description "Remove database, jre and sdk files. This will more or less reset your working environment."

    doLast {
        if (OperatingSystem.current().isWindows()) {

        }

        if (OperatingSystem.current().isLinux()) {
            exec {
                workingDir './'
                commandLine './scripts/kill.sh'
            }
        }
    }
}

task addplugin {
    group "Jetty"
    description "Create plugin configuration given a path to a plugin development directory"

    doLast {
        println "hi there"
    }
}

// helper functions
ext.getZip = { path ->
    String filter
    if (project.hasProperty('sdk')) {
        filter = '*' + sdk + '*.zip'
    } else {
        filter = '*.zip'
    }

    FileTree zips = fileTree(dir: path).include(filter)

    if (zips.getFiles().size() > 1) {
        throw new InvalidUserDataException('More than one zip file detected in ' + path +'. Ambiguous configuration. ' +
                'Please specify an sdk version with \'-Psdk\'')
    }

    File zip = zips.getFiles().toArray()[0]
    return zip
}
