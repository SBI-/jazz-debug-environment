apply plugin: 'java'

import org.gradle.internal.os.OperatingSystem;

task detect {
    doLast {
        println("Linux: " + OperatingSystem.current().isLinux())
        println("Windows: " + OperatingSystem.current().isWindows())
    }
}

task cleanup(type: Exec) {
    group "Jetty"
    description "Delete generated and runtime files"
    if (OperatingSystem.current().isWindows()) {
        workingDir './'
        commandLine 'powershell.exe', './scripts/clean.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
        workingDir './'
        commandLine './clean.sh'
    }
}

task generate(type: Exec) {
    group "Jetty"
    description "Create jazz and equinox configuration files"
    if (OperatingSystem.current().isWindows()) {
        workingDir 'conf/jetty'
        commandLine 'powershell.exe', '../../scripts/generate_jetty_config.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
        workingDir './conf/jetty'
        commandLine './generate_jetty_config.sh'
        ignoreExitValue true
    }
}

task run(type: Exec) {
    group "Jetty"
    description "Start jazz server"
    if (OperatingSystem.current().isWindows()) {
        workingDir './'
        commandLine 'cmd', '/K', 'start', 'powershell','./scripts/run_jetty.ps1'
    }

    if (OperatingSystem.current().isLinux()) {
    }
}

// remember: https://stackoverflow.com/a/19256949/1969804 for dynamic lookup and stuff.
task unzip {
    group "Jetty"
    description "Unzip sdk and server files into the correct folders"

    if (OperatingSystem.current().isWindows()) {
        exec {
            workingDir './sdk'
            commandLine 'powershell', '7z.exe', 'x', 'RTC-SDK-Server-6.0.3.zip'
        }

        exec {
            workingDir './jre'
            commandLine 'powershell', '7z.exe', 'x', 'JTS-CCM-keys-Win64_6.0.3.zip', 'server\\jre', '-r', ';',
                    'mv server\\jre\\* .', ';', 'rm -r server'
        }
    }
}
